---
layout: post
title: "RocketMQ的使用"
date: 2022-02-13 10:45:12
categories: mq
keywords: "mq,RocketMQ,消息中间件"
description: "RocketMQ的使用"
---

## 一、RocketMQ介绍

#### MQ作用

![MQ-worker](/img/rocketmq/MQ-worker.png)

MQ是一种""先进先出"的数据结构，主要包含以下三个作用

- 应用解耦

​		系统的耦合性越高，容错性就越低。例如下订单如果RPC调用仓储系统，如果仓储系统出库模块异常将导致订单无法创建，这基本是我们无法容忍的。所以可以采用MQ的方式，接收创建订单成功的消息调用仓储出库。

- 流量削峰

​		应用系统如果遇到系统请求流量的瞬间猛增，有可能会将系统压垮。有了消息队列可以将大量请求缓存起来，分散到很长一段时间处理，这样可以大大提到系统的稳定性和用户体验。

- 异步执行

​		通过消息队列可以让数据在多个系统更加之间进行流通。数据的产生方不需要关心谁来使用数据，只需要将数据发送到消息队列，数据使用方直接在消息队列中直接获取数据即可。

#### 各种MQ产品的比较

| 特性           | ActiveMQ                                                     | RabbitMQ                                                     | RocketMQ                 | kafka                                                        |
| -------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------ | ------------------------------------------------------------ |
| **开发语言**   | java                                                         | erlang                                                       | java                     | scala                                                        |
| **单机吞吐量** | 万级                                                         | 万级                                                         | 10万级                   | 10万级                                                       |
| **时效性**     | ms级                                                         | us级                                                         | ms级                     | ms级以内                                                     |
| **可用性**     | 高(主从架构)                                                 | 高(主从架构)                                                 | 非常高(分布式架构)       | 非常高(分布式架构)                                           |
| **功能特性**   | 成熟的产品，在很多公司得到应用；有较多的文档；各种协议支持较好 | 基于erlang开发，所以并发能力很强，性能极其好，延时很低;管理界面较丰富 | MQ功能比较完备，扩展性佳 | 只支持主要的MQ功能，像一些消息查询，消息回溯等功能没有提供，毕竟是为大数据准备的，在大数据领域应用广 |

#### RocketMQ各角色介绍

| 角色          | 含义                                                   |
| ------------- | ------------------------------------------------------ |
| Producer      | 消息的发送者                                           |
| Consumer      | 消息接收者                                             |
| Broker        | 暂存和传输消息                                         |
| NameServer    | 管理Broker，发送者和消费者从NameServer找到对应的Broker |
| Topic         | 消息主题                                               |
| Message Queue | 相当于是Topic的分区                                    |

<img src="/img/rocketmq/RocketMQ-role.png" alt="RocketMQ-role" style="zoom:80%;" />

## 二、RocketMQ集群搭建

前置条件：JDK1.8

RocketMQ[下载地址](https://rocketmq.apache.org/)、RocketMQ-Externals（GUI管理界面）[下载地址](https://github.com/apache/rocketmq-dashboard)

### 各角色之间的关系

- NameServer是一个几乎无状态节点。可集群部署，节点之间无任何信息同步。

- Broker部署相对复杂，Broker分为Master与Slave，一个Master可以对应多个Slave，但是一个Slave只能对应一个Master，Master与Slave的对应关系通过指定相同的BrokerName，不同的BrokerId来定义，BrokerId为0表示Master，非0表示Slave。Master也可以部署多个。每个Broker与NameServer集群中的所有节点建立长连接，定时注册Topic信息到所有NameServer。
- Producer与NameServer集群中的其中一个节点（随机选择）建立长连接，定期从NameServer取Topic路由信息，并向提供Topic服务的Master建立长连接，且定时向Master发送心跳。Producer完全无状态，可集群部署。
- Consumer与NameServer集群中的其中一个节点（随机选择）建立长连接，定期从NameServer取Topic路由信息，并向提供Topic服务的Master、Slave建立长连接，且定时向Master、Slave发送心跳。Consumer既可以从Master订阅消息，也可以从Slave订阅消息，订阅规则由Broker配置决定。

### 2Master-2Slave的RocketMQ服务搭建

![rmq-basic-arc](/img/rocketmq/rmq-basic-arc.png)

角色介绍

| IP             | 角色                     | 架构模式                    |
| -------------- | ------------------------ | --------------------------- |
| 192.168.22.162 | nameserver、brokerserver | Master1、Slave2、NameServer |
| 192.168.22.163 | nameserver、brokerserver | Master2、Slave1、NameServer |

第一步：两台机器都解压

```shell
unzip rocketmq-all-[version]-bin-release.zip
mv rocketmq-[version] /opt/module
mv /opt/module/rocketmq-[version] /opt/module/rocketmq
```

第二步：两台机器都创建消息存储目录

```shell
# 192.168.22.162
mkdir -p /opt/module/rocketmq/store/broker-a
mkdir -p /opt/module/rocketmq/store/broker-b-s

# 192.168.22.163
mkdir -p /opt/module/rocketmq/store/broker-b
mkdir -p /opt/module/rocketmq/store/broker-a-s
```

第三步：

- 配置`192.168.22.162`的`master1`，编辑`/opt/module/rocketmq/conf/2m-2s-sync/broker-a.properties `（可重命名），删除` broker-a-s.properties`

```properties
# 所属集群名字
brokerClusterName=rocketmq-cluster
# broker名字，注意此处不同的配置文件填写的不一样
brokerName=broker-a
# 0表示Master，1表示Slave
brokerId=0
# nameServer地址，分号分割
namesrvAddr=192.168.22.162:9876;192.168.22.163:9876
# 在发送消息时，自动创建服务器不存在的topic，默认创建的队列数
defaultTopicQueueNums=4
# 是否允许Broker自动创建Topic，建议线下开启，线上关闭
autoCreateTopicEnable=true
# 是否允许Broker自动创建订阅组，建议线下开启，线上关闭
autoCreateSubscriptionGroup=true
# Broker对外服务的监听端口，不可重复
listenPort=10911
# 删除文件时间点，默认凌晨4点
deleteWhen=04
# 文件保留时间，默认48小时
fileReservedTime=120
# commitLog每个文件的大小默认1G
mapedFileSizeCommitLog=1073741824
# consumeQueue每个文件默认存30W条，根据业务情况调整
mapedFileSizeConsumeQueue=300000
#destroyMapedFileIntervalForcibly=120000
#redeleteHangedFileInterval=120000
# 检测物理文件磁盘空间
diskMaxUsedSpaceRatio=88
# 存储路径
storePathRootDir=/opt/module/rocketmq/store/broker-a
# 限制的消息大小
maxMessageSize=65536
#flushCommitLogLeastPages=4
#flushConsumeQueueLeastPages=2
#flushCommitLogThoroughInterval=10000
#flushConsumeQueueThoroughInterval=60000
# Broker 的角色
#  - ASYNC_MASTER 异步复制Master
#  - SYNC_MASTER 同步双写Master
#  - SLAVE
brokerRole=SYNC_MASTER
# 刷盘方式
#  - ASYNC_FLUSH 异步刷盘
#  - SYNC_FLUSH 同步刷盘
flushDiskType=SYNC_FLUSH
#checkTransactionMessageEnable=false
# 发消息线程池数量
#sendMessageThreadPoolNums=128
# 拉消息线程池数量
#pullMessageThreadPoolNums=128
```

- 配置`192.168.22.162`的`slave2`，编辑`/opt/module/rocketmq/conf/2m-2s-sync/broker-b-s.properties `（可重命名），删除` broker-b.properties`

```properties
# 所属集群名字
brokerClusterName=rocketmq-cluster
# broker名字，注意此处不同的配置文件填写的不一样
brokerName=broker-b
# 0表示Master，1表示Slave
brokerId=1
# nameServer地址，分号分割
namesrvAddr=192.168.22.162:9876;192.168.22.163:9876
# 在发送消息时，自动创建服务器不存在的topic，默认创建的队列数
defaultTopicQueueNums=4
# 是否允许Broker自动创建Topic，建议线下开启，线上关闭
autoCreateTopicEnable=true
# 是否允许Broker自动创建订阅组，建议线下开启，线上关闭
autoCreateSubscriptionGroup=true
# Broker 对外服务的监听端口
listenPort=11011
# 删除文件时间点，默认凌晨 4点
deleteWhen=04
# 文件保留时间，默认 48 小时
fileReservedTime=120
# commitLog每个文件的大小默认1G
mapedFileSizeCommitLog=1073741824
# ConsumeQueue每个文件默认存30W条，根据业务情况调整
mapedFileSizeConsumeQueue=300000
#destroyMapedFileIntervalForcibly=120000
#redeleteHangedFileInterval=120000
# 检测物理文件磁盘空间
diskMaxUsedSpaceRatio=88
# 存储路径
storePathRootDir=/opt/module/rocketmq/store/broker-b-s
# 限制的消息大小
maxMessageSize=65536
#flushCommitLogLeastPages=4
#flushConsumeQueueLeastPages=2
#flushCommitLogThoroughInterval=10000
#flushConsumeQueueThoroughInterval=60000
# Broker 的角色
#  - ASYNC_MASTER 异步复制Master
#  - SYNC_MASTER 同步双写Master
#  - SLAVE
brokerRole=SLAVE
# 刷盘方式
#  - ASYNC_FLUSH 异步刷盘
#  - SYNC_FLUSH 同步刷盘
flushDiskType=ASYNC_FLUSH
#checkTransactionMessageEnable=false
# 发消息线程池数量
#sendMessageThreadPoolNums=128
# 拉消息线程池数量
#pullMessageThreadPoolNums=128
```

- 配置`192.168.22.163`的`master2`，编辑`/opt/module/rocketmq/conf/2m-2s-sync/broker-b.properties `（可重命名），删除` broker-b-s.properties`

```properties
# 所属集群名字
brokerClusterName=rocketmq-cluster
# broker名字，注意此处不同的配置文件填写的不一样
brokerName=broker-b
# 0表示Master，1表示Slave
brokerId=0
# nameServer地址，分号分割
namesrvAddr=192.168.22.162:9876;192.168.22.163:9876
# 在发送消息时，自动创建服务器不存在的topic，默认创建的队列数
defaultTopicQueueNums=4
# 是否允许Broker自动创建Topic，建议线下开启，线上关闭
autoCreateTopicEnable=true
# 是否允许Broker自动创建订阅组，建议线下开启，线上关闭
autoCreateSubscriptionGroup=true
# Broker对外服务的监听端口，不可重复
listenPort=10911
# 删除文件时间点，默认凌晨4点
deleteWhen=04
# 文件保留时间，默认48小时
fileReservedTime=120
# commitLog每个文件的大小默认1G
mapedFileSizeCommitLog=1073741824
# consumeQueue每个文件默认存30W条，根据业务情况调整
mapedFileSizeConsumeQueue=300000
#destroyMapedFileIntervalForcibly=120000
#redeleteHangedFileInterval=120000
# 检测物理文件磁盘空间
diskMaxUsedSpaceRatio=88
# 存储路径
storePathRootDir=/opt/module/rocketmq/store/broker-b
# 限制的消息大小
maxMessageSize=65536
#flushCommitLogLeastPages=4
#flushConsumeQueueLeastPages=2
#flushCommitLogThoroughInterval=10000
#flushConsumeQueueThoroughInterval=60000
# Broker 的角色
#  - ASYNC_MASTER 异步复制Master
#  - SYNC_MASTER 同步双写Master
#  - SLAVE
brokerRole=SYNC_MASTER
# 刷盘方式
#  - ASYNC_FLUSH 异步刷盘
#  - SYNC_FLUSH 同步刷盘
flushDiskType=SYNC_FLUSH
#checkTransactionMessageEnable=false
# 发消息线程池数量
#sendMessageThreadPoolNums=128
# 拉消息线程池数量
#pullMessageThreadPoolNums=128
```

- 配置`192.168.22.163`的`slave1`，编辑`/opt/module/rocketmq/conf/2m-2s-sync/broker-a-s.properties `（可重命名），删除` broker-a.properties`

```properties
# 所属集群名字
brokerClusterName=rocketmq-cluster
# broker名字，注意此处不同的配置文件填写的不一样
brokerName=broker-a
# 0表示Master，1表示Slave
brokerId=1
# nameServer地址，分号分割
namesrvAddr=192.168.22.162:9876;192.168.22.163:9876
# 在发送消息时，自动创建服务器不存在的topic，默认创建的队列数
defaultTopicQueueNums=4
# 是否允许Broker自动创建Topic，建议线下开启，线上关闭
autoCreateTopicEnable=true
# 是否允许Broker自动创建订阅组，建议线下开启，线上关闭
autoCreateSubscriptionGroup=true
# Broker 对外服务的监听端口
listenPort=11011
# 删除文件时间点，默认凌晨 4点
deleteWhen=04
# 文件保留时间，默认 48 小时
fileReservedTime=120
# commitLog每个文件的大小默认1G
mapedFileSizeCommitLog=1073741824
# ConsumeQueue每个文件默认存30W条，根据业务情况调整
mapedFileSizeConsumeQueue=300000
#destroyMapedFileIntervalForcibly=120000
#redeleteHangedFileInterval=120000
# 检测物理文件磁盘空间
diskMaxUsedSpaceRatio=88
# 存储路径
storePathRootDir=/opt/module/rocketmq/store/broker-a-s
# 限制的消息大小
maxMessageSize=65536
#flushCommitLogLeastPages=4
#flushConsumeQueueLeastPages=2
#flushCommitLogThoroughInterval=10000
#flushConsumeQueueThoroughInterval=60000
# Broker 的角色
#  - ASYNC_MASTER 异步复制Master
#  - SYNC_MASTER 同步双写Master
#  - SLAVE
brokerRole=SLAVE
# 刷盘方式
#  - ASYNC_FLUSH 异步刷盘
#  - SYNC_FLUSH 同步刷盘
flushDiskType=ASYNC_FLUSH
#checkTransactionMessageEnable=false
# 发消息线程池数量
#sendMessageThreadPoolNums=128
# 拉消息线程池数量
#pullMessageThreadPoolNums=128
```

第四步：修改启动脚本文件

修改`/opt/module/rocketmq/bin/runbroker.sh`

```bash
#===================================================
# 开发环境配置 JVM Configuration
JAVA_OPT="${JAVA_OPT} -server -Xms256m -Xmx256m -Xmn128m"
```

修改`/opt/module/rocketmq/bin/runserver.sh`

```bash
#===================================================
# 开发环境配置 JVM Configuration
JAVA_OPT="${JAVA_OPT} -server -Xms256m -Xmx256m -Xmn128m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m"
```

第五步：启动NameServe集群，分别在两台机器都启动NameServer

```shell
# 1.启动NameServer
nohup sh mqnamesrv > mqnamesrv.log  2>&1 &
# 查看进程
jps
```

第六步：在192.168.22.162上启动master1和slave2

```shell
nohup sh mqbroker -c /opt/module/rocketmq/conf/2m-2s-sync/broker-a.properties > broker-a.log  2>&1 &
nohup sh mqbroker -c /opt/module/rocketmq/conf/2m-2s-sync/broker-b-s.properties > broker-b-s.log  2>&1 &
jps
```

第七步：在192.168.22.163上启动master2和slave1

```shell
nohup sh mqbroker -c /opt/module/rocketmq/conf/2m-2s-sync/broker-b.properties > broker-b.log  2>&1 &
nohup sh mqbroker -c /opt/module/rocketmq/conf/2m-2s-sync/broker-a-s.properties > broker-a-s.log  2>&1 &
jps
```

> 关闭broker命令：sh mqshutdown broker

### 集群监控平台搭建

[下载源码包](https://github.com/apache/rocketmq-dashboard)，修改`application.properties`文件

```properties
rocketmq.config.namesrvAddr=192.168.22.162:9876;192.168.22.163:9876
```

打包编译运行即可

```sh
mvn clean package -Dmaven.test.skip=true
java -jar target/rocketmq-dashboard-[version].jar
```

